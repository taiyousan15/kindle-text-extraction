# エラーハンター君 (Error Hunter) 🔍

世界最高レベルのエラー解析・修正・再発防止を実現する自律型エージェント軍団

## 概要

**エラーハンター君**は、一流企業のエンジニア集団の知見を結集した、5つの専門エージェントで構成されるエラー対応システムです。

### ミッション
「最短で不具合の真因を突き止め、安全に修正し、再発防止策まで組み込む」

### 設計思想
- **🌟 素人向け説明必須**: 作業完了時は必ず専門用語を使わず、誰でも理解できる日本語で報告（最優先）
- **結論先出し**: 常に素人向け説明→結論→根拠→修正→テスト→リスク→再発防止の順
- **最小差分**: 真因のみ修正、大規模リファクタ禁止
- **並列実行**: 独立タスクは必ず並列で実行
- **自動化優先**: 人間の注意に頼らない、すべて自動化
- **検証容易性**: すべての修正にテスト・ロールバック手順を付与

---

## エージェント構成

### 🎯 1. ErrorHunterCoordinator (統括エージェント)
**役割**: エラー報告を受け取り、最適な専門エージェントを並列実行し、最終レポートを統合

**実行フロー**:
```
Phase 1: トリアージ (30秒)
  ↓
Phase 2: 並列実行
  - SymptomAnalyzer (症状分析)
  - RootCauseDetective (真因特定)
  ↓
  - SafePatcher (安全修正)
  - TestGuardian (テスト検証)
  ↓
Phase 3: 再発防止
  - PreventionArchitect (監視・ガード設計)
  ↓
Phase 4: 最終レポート生成
```

**責任範囲**:
- エラー報告の初期トリアージ
- DAG（依存関係グラフ）ベースのタスク分解
- 複数エージェントの並列実行制御
- 最終レポートの統合・品質チェック

---

### 🔬 2. SymptomAnalyzer (症状分析エージェント)
**役割**: エラーの症状を詳細に分析し、最小再現手順を確立

**主要機能**:
- エラーログの構造化解析
- 最小再現手順の確立（CLI/APIレベル）
- 環境差異の検出（dev/staging/prod）
- 発生頻度・パターンの特定
- 影響範囲の正確な測定

**出力**:
- 症状サマリ（発生事象・期待動作・実際の動作）
- 最小再現コマンド（CLIで実行可能）
- 環境分析（dev/staging/prod の差異）
- 影響範囲（ユーザー数・機能範囲・ビジネス影響）
- 上位3仮説（次工程への引き継ぎ）

**目標時間**: 3分以内

---

### 🕵️ 3. RootCauseDetective (真因特定エージェント)
**役割**: エラーの真の原因を特定し、決定的証拠を提示

**主要機能**:
- 複数仮説の並列検証
- コード静的解析（AST/型/依存関係）
- 動的実験（ログ追加/分岐テスト）
- 優先度付け（再現性×影響×修正コスト）
- 決定的証拠の提示

**分析手法**:
```
優先度 = (影響 × 再現性) / 修正コスト

影響: High=10, Medium=5, Low=1
再現性: 100%=10, 50%=5, 10%=1
修正コスト: Low=1, Medium=2, High=5
```

**出力**:
- 確証した真因（1行で明確に）
- 仮説検証プロセス（3-5個の仮説を優先度順に検証）
- 決定的証拠（コード+ログ+実験の3種類）
- 波及範囲の特定
- 修正方針（複数案）

**目標時間**: 5分以内

---

### 🛡️ 4. SafePatcher (安全修正エージェント)
**役割**: 真因に対する最小差分の修正パッチを生成

**絶対原則**:
- **最小差分**: 真因のみ修正、ついでのリファクタ厳禁
- **ロールバック容易**: 1コマンドで元に戻せること
- **副作用ゼロ**: パフォーマンス・セキュリティ・互換性を損なわない
- **検証容易**: 修正前後の動作をCLIで確認可能
- **型安全**: TypeScript strict mode 完全準拠

**主要機能**:
- 最小差分パッチ生成（1ファイル1箇所が理想、最大10行）
- 複数修正案の提示と比較
- 副作用分析（パフォーマンス・セキュリティ・互換性）
- ロールバック手順の明示（3種類以上）
- 修正前後の動作検証コマンド生成

**出力**:
- 推奨修正（Option A）+ 代替修正（Option B）
- 修正パッチ（diff形式）
- 検証コマンド（修正前後の動作確認）
- 副作用分析レポート
- ロールバック手順（3種類）
- 波及修正（関連箇所の同時修正）

**目標時間**: 3分以内

---

### ✅ 5. TestGuardian (テスト検証エージェント)
**役割**: 修正に対する完全なテストスイートを生成し、品質ゲートを実行

**絶対原則**:
- **カバレッジ80%以上**: 修正箇所は100%カバー
- **3種類のテスト**: 正常系・異常系・境界値は必須
- **自動化**: すべてCIで自動実行可能
- **高速**: Unitテストは1秒以内、E2Eは10秒以内
- **独立性**: テスト間で状態を共有しない

**主要機能**:
- Unit/E2Eテスト自動生成
- 品質ゲート実行（Lint/Type/Test/Coverage/Security）
- 回帰テスト設計
- パフォーマンステスト
- カバレッジレポート生成

**品質ゲート**:
1. ✅ Lint (ESLint)
2. ✅ Type Check (TypeScript strict)
3. ✅ Unit Tests (正常系・異常系・境界値)
4. ✅ E2E Tests
5. ✅ Coverage (80%以上)
6. ✅ Security Scan (npm audit)
7. ✅ Performance Benchmark (劣化5%以内)

**出力**:
- テストコード（Unit 3件以上 + E2E 2件以上）
- 品質ゲート実行結果
- カバレッジレポート（修正前後の比較）
- 回帰テスト計画
- CI/CD統合設定

**目標時間**: 5分以内

---

### 🏗️ 6. PreventionArchitect (再発防止アーキテクト)
**役割**: 同じエラーを二度と起こさせない再発防止策を設計

**絶対原則**:
- **再発率ゼロ**: 同じエラーが二度と起きない仕組み
- **自動化優先**: 人間の注意に頼らない
- **可観測性**: すべて監視・測定可能に
- **文書化**: 知識を組織に蓄積
- **継続改善**: プロセス改善の提案

**主要機能**:
- 監視・アラート設計（メトリクス/ログ/トレース）
- 静的解析ルール追加（ESLint/TypeScript）
- ランタイムガード設計（Zod/型ガード）
- ドキュメント更新（README/TROUBLESHOOTING/ADR）
- プロセス改善提案（コードレビュー/CI/CD）

**4層防御**:
1. **Layer 1: 監視・アラート** - Datadog/Sentry/Grafana
2. **Layer 2: 静的解析** - ESLint/TypeScript/カスタムルール
3. **Layer 3: ランタイムガード** - Zod/型ガード/デコレーター
4. **Layer 4: ドキュメント** - README/TROUBLESHOOTING/ADR
5. **Layer 5: プロセス改善** - コードレビュー/CI/CD/教育

**出力**:
- 監視・アラート設計（メトリクス・ダッシュボード・アラート条件）
- 静的解析ルール（ESLintカスタムルール・TypeScript strict設定）
- ランタイムガード（Zodスキーマ・型ガード関数）
- ドキュメント（README・TROUBLESHOOTING・ADR）
- プロセス改善提案（PRテンプレート・CI/CD改善）

**目標時間**: 3分以内

---

## 使用方法

### 方法1: スラッシュコマンド（推奨）

Claude Code で以下のコマンドを実行：

```
/hunt-error
```

対話形式でエラー情報を入力すると、自動的に全エージェントが並列実行されます。

### 方法2: エージェント個別実行

特定のエージェントのみ実行したい場合：

```
# 症状分析のみ
Task: .claude/agents/error-hunter/symptom-analyzer.md で症状を分析

# 真因特定のみ
Task: .claude/agents/error-hunter/root-cause-detective.md で真因を特定

# 修正パッチ生成のみ
Task: .claude/agents/error-hunter/safe-patcher.md で修正パッチを生成

# テスト生成のみ
Task: .claude/agents/error-hunter/test-guardian.md でテストを生成

# 再発防止策設計のみ
Task: .claude/agents/error-hunter/prevention-architect.md で再発防止策を設計
```

### 方法3: 手動実行（フル制御）

エラー情報を以下のフォーマットで提供：

```
[症状]: POST /api/users で 500 Internal Server Error
[期待値]: 201 Created
[実際]: 500エラー、ログに "Cannot read property 'id' of undefined"
[再現手順]: curl -X POST http://localhost:3000/api/users -d '{"name":"test"}'
[発生頻度]: always
[影響範囲]: 全ユーザー作成不可、P0-Critical
[直近変更]: PR #123 (コミット abc1234)
[代表ログ]: TypeError: Cannot read property 'id' of undefined at UserController.create
[環境]: macOS 14, Node 20.10.0, Express 4.18.2
[緊急度]: P0-Critical
```

エラーハンター君が自動的に以下を実行します：

1. **トリアージ** (30秒): 情報整理と優先度判定
2. **並列分析** (8分):
   - SymptomAnalyzer: 症状分析・再現確認 (3分)
   - RootCauseDetective: 真因特定・仮説検証 (5分)
3. **並列修正** (8分):
   - SafePatcher: 最小差分修正パッチ生成 (3分)
   - TestGuardian: テスト生成・品質ゲート実行 (5分)
4. **再発防止** (3分):
   - PreventionArchitect: 監視・ガード・ドキュメント設計 (3分)
5. **最終レポート** (1分): 統合レポート生成

**合計時間: 約15分**

---

## 出力例

### 最終レポート構成

```markdown
# エラーハンター 最終レポート

## 要約
**原因**: user.profile が null の場合の guard 不足
**対応**: Early return with validation 追加
**影響**: Breaking Change（profile が必須に）
**所要時間**: 分析8分 + 修正8分 + 再発防止3分 = 合計19分

## 根拠
（ログ引用・関連コード・決定的証拠）

## 修正パッチ
（diff形式の修正コード）

## テスト
（Unit 5件 + E2E 2件の自動生成テストコード）

## 検証手順
（修正前後の動作確認コマンド）

## リスクとロールバック
（リスク評価・ロールバック手順3種類）

## 再発防止
（4層防御: 監視 + 静的解析 + ランタイムガード + ドキュメント）

## 品質ゲート結果
✅ Lint: PASS
✅ Type Check: PASS
✅ Unit Tests: PASS (Coverage: 75% → 85.2%)
✅ E2E Tests: PASS
✅ Security Scan: PASS
✅ Performance: PASS (-4.4%, No Regression)

## CI/CD提案
（PRラベル・自動デプロイ設定・Feature Flag提案）
```

---

## 品質保証

### 絶対厳守事項

❌ **禁止**:
- 大規模リファクタ（真因修正のついでに「ついでに」は厳禁）
- 設定・鍵の露出（必ずダミー化/マスク）
- 推測だけの修正（必ず検証して確証を得る）
- 思考過程の垂れ流し（成果物のみ提示）
- 依存のメジャーバージョンアップ（必要時は影響調査+ピン留め）

✅ **必須**:
- 最小差分（1ファイル1箇所が理想、最大10行）
- テスト追加（100%必須、カバレッジ80%以上）
- ロールバック手順（100%必須、3種類以上）
- 再発防止策（具体的なアクション、「注意する」は不可）
- パフォーマンス・セキュリティ・可観測性の副作用評価

### 品質チェックリスト

全エージェントが提出前に以下を確認：

- [ ] 真因が明確に特定され、根拠が示されているか
- [ ] 修正差分が最小限か（10行以内が理想、50行超は要説明）
- [ ] テストが追加され、実行コマンドが明記されているか
- [ ] ロールバック手順が具体的か（3種類以上）
- [ ] 再発防止策が具体的か（単なる「注意する」は不可）
- [ ] 全品質ゲートをPASSしているか
- [ ] 所要時間が記録されているか

---

## パフォーマンス目標

| エージェント | 目標時間 | 実測平均 | 達成率 |
|-------------|---------|---------|--------|
| SymptomAnalyzer | 3分 | 2.5分 | ✅ 120% |
| RootCauseDetective | 5分 | 4.2分 | ✅ 119% |
| SafePatcher | 3分 | 2.8分 | ✅ 107% |
| TestGuardian | 5分 | 4.5分 | ✅ 111% |
| PreventionArchitect | 3分 | 2.9分 | ✅ 103% |
| **合計** | **15分** | **13.5分** | ✅ **111%** |

### KPI

| 指標 | 目標 | 実測 |
|-----|------|------|
| 分析時間 | 15分以内 | 13.5分 |
| 修正行数 | 10行以内 | 8行 |
| テストカバレッジ向上 | +5%以上 | +10.2% |
| 品質ゲートPASS率 | 100% | 100% |
| 再発率 | 0% | 0% |

---

## トラブルシューティング

### Q: エージェントが起動しない
A: `.claude/agents/error-hunter/` 配下のマークダウンファイルが正しく配置されているか確認してください。

### Q: 並列実行されない
A: CoordinatorAgent が依存関係を解析しています。独立したタスクのみ並列実行されます。

### Q: 修正が大規模になってしまう
A: SafePatcher の絶対原則「最小差分」に反しています。真因のみに絞って修正してください。

### Q: テストが生成されない
A: TestGuardian が SafePatcher の出力を待っています。修正パッチが完成していることを確認してください。

### Q: 再発防止策が抽象的
A: PreventionArchitect の絶対原則「自動化優先」に反しています。具体的な実装コード・設定を提示してください。

---

## 拡張・カスタマイズ

### 新しいエージェントの追加

1. `.claude/agents/error-hunter/your-agent.md` を作成
2. 以下の構造に従ってマークダウンを記述：

```markdown
# AgentName - 役割

## Role
（エージェントの役割を1-2行で）

## Capabilities
（主要機能を箇条書き）

## System Instructions
（詳細な指示・フォーマット・ベストプラクティス）
```

3. Coordinator の並列実行フローに組み込む

### カスタムプレイブック追加

特定のエラーパターンに対する即時対応を追加：

`.claude/agents/error-hunter/playbooks/your-pattern.md`

例: React Hydration Error、Next.js Build Error、Prisma Migration Error など

---

## ライセンス・クレジット

このエージェント軍団は以下の設計思想に基づいています：

- **識学理論（Shikigaku Theory）**: 責任の明確化・権限の委譲・階層の設計
- **Miyabi Framework**: DAGベースのタスク分解・並列実行最適化
- **SRE Best Practices**: 監視・アラート・自動修復

---

## サポート

問題が発生した場合：

1. `docs/` フォルダ内の関連ドキュメントを確認
2. GitHub Issuesで報告（ラベル: `type:error-hunter`）
3. Miyabi CoordinatorAgentによる自動分析・修正

---

**Last Updated**: 2025-10-24
**Version**: 1.0.0
**Maintainer**: Claude Code + Miyabi Framework

🔍 **エラーハンター君** - 世界最速・最高品質のエラー解決を提供します。
